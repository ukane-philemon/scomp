package graph

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.49

import (
	"context"
	"errors"
	"fmt"
	"log"

	"github.com/ukane-philemon/scomp/graph/model"
	"github.com/ukane-philemon/scomp/internal/db"
)

// serverError is a generic error sent for server related errors.
var serverError = errors.New("Something unexpected happened, please try again later")

// CreateAdminAccount is the resolver for the createAdminAccount field.
func (r *mutationResolver) CreateAdminAccount(ctx context.Context, username string, password string) (string, error) {
	err := r.db.CreateAdminAccount(username, password)
	if err != nil {
		return "", handleError(err)
	}

	return "Admin account created successfully, proceed to login.", nil
}

// Login is the resolver for the login field.
func (r *mutationResolver) Login(ctx context.Context, username string, password string) (*model.LoginResponse, error) {
	adminInfo, err := r.db.Login(username, password)
	if err != nil {
		return nil, handleError(err)
	}

	authToken, err := r.JWTManager.GenerateJWtToken(adminInfo.ID)
	if err != nil {
		return nil, handleError(err)
	}

	return &model.LoginResponse{
		AuthToken: authToken,
		AdminInfo: adminInfo,
	}, nil
}

// CreateClass is the resolver for the createClass field.
func (r *mutationResolver) CreateClass(ctx context.Context, class model.NewClass) (string, error) {
	panic(fmt.Errorf("not implemented: CreateClass - createClass"))
}

// AddStudentRecord is the resolver for the addStudentRecord field.
func (r *mutationResolver) AddStudentRecord(ctx context.Context, classID string, student model.StudentRecordInput) (string, error) {
	panic(fmt.Errorf("not implemented: AddStudentRecord - addStudentRecord"))
}

// ComputeClassReport is the resolver for the computeClassReport field.
func (r *mutationResolver) ComputeClassReport(ctx context.Context, classID string) (*model.ClassInfo, error) {
	panic(fmt.Errorf("not implemented: ComputeClassReport - computeClassReport"))
}

// ClassInfo is the resolver for the classInfo field.
func (r *queryResolver) ClassInfo(ctx context.Context, classID string) (*model.ClassInfo, error) {
	panic(fmt.Errorf("not implemented: ClassInfo - classInfo"))
}

// Classes is the resolver for the classes field.
func (r *queryResolver) Classes(ctx context.Context, hasReport *bool) ([]*model.ClassInfo, error) {
	panic(fmt.Errorf("not implemented: Classes - classes"))
}

// StudentRecord is the resolver for the studentRecord field.
func (r *queryResolver) StudentRecord(ctx context.Context, classID string, studentID string) (*model.StudentRecord, error) {
	panic(fmt.Errorf("not implemented: StudentRecord - studentRecord"))
}

// Mutation returns MutationResolver implementation.
func (r *Resolver) Mutation() MutationResolver { return &mutationResolver{r} }

// Query returns QueryResolver implementation.
func (r *Resolver) Query() QueryResolver { return &queryResolver{r} }

type mutationResolver struct{ *Resolver }
type queryResolver struct{ *Resolver }

// handleError checks if the provided error is a server related error and logs it
// or just returns the error.
func handleError(err error) error {
	if errors.Is(err, db.ErrorInvalidRequest) {
		return err
	}

	log.Printf("\nSERVER ERROR: %v", err.Error())
	return serverError
}
